<!DOCTYPE html>
<html lang="en-us"
  dir="ltr">

<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">

<meta name="ICBM" content="19.0760, 72.8777">
<meta name="geo.position" content="19.0760;72.8777">
<meta name="geo.region" content="IN-MH">
<meta name="geo.placename" content="Mumbai">
<title>[project]æ­è½½äºå¯†é—­ç¯å¢ƒæ£€æµ‹æ— äººæœºçš„ç¯å¢ƒæ•°æ®é‡‡é›†ä¸ä¸ŠæŠ¥æ¨¡å— | xym-ee</title>


        <link rel="stylesheet" href="/css/tailwind.min.ce97201a436e89554f6444624e62d4b32a48d70d124d557a1852401701ab43bc.css" type="text/css" integrity="sha256-zpcgGkNuiVVPZERiTmLUsypI1w0STVV6GFJAFwGrQ7w=" crossorigin="anonymous">

</head>

<body class="bg-gradient-to-r from-slate-900 to-slate-800 font-mono text-white">
  <div class="container mx-auto flex flex-col px-4 xl:w-8/12 sm:max-w-full">
    
  

  <header class="flex flex-row py-4" >

  



  <nav
    class="flex flex-row items-center w-full justify-between">


  
  
    <div class="flex flex-col gap-1">
      <a href="https://xym.work/" class="text-4xl font-bold hover:text-sky-400 whitespace-nowrap">xym-ee</a>
      <p>Embedded Systems & Robot Control</p>
    </div>
  

  <div class="dropdown-menu flex flex-row absolute max-lg:w-full max-lg:items-center max-lg:justify-center max-lg:-top-full lg:static max-lg:bg-slate-900 max-lg:h-[calc(100dvh)] max-lg:left-0">
    <ul class="flex flex-col lg:flex-row gap-2">
      
  <li class="font-bold border border-sky-400 px-3 py-2 hover:bg-sky-400 focus:text-sky-400 text-center">
    <a href="/about.html">About</a>
  </li>

  <li class="font-bold border border-sky-400 px-3 py-2 hover:bg-sky-400 focus:text-sky-400 text-center">
    <a href="/blog">Blog</a>
  </li>

  <li class="font-bold border border-sky-400 px-3 py-2 hover:bg-sky-400 focus:text-sky-400 text-center">
    <a href="/notebook.html">Notebook</a>
  </li>

    </ul>
  </div>
  <div class="open-dropdown-button lg:hidden">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" width="32" height="32" fill="white">
      <path
        d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z" />
    </svg>
  </div>
  <div class="close-dropdown-button hidden z-50">
    <svg xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 384 512" width="32" height="32" fill="white">
      <path
        d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z" />
    </svg>
  </div>
</nav>
</header>

  
  <div class="flex flex-col pt-8 gap-10">
    
    <div class="flex flex-col w-full gap-4">
      <h2 class="text-3xl max-sm:text-2xl font-bold">[project]æ­è½½äºå¯†é—­ç¯å¢ƒæ£€æµ‹æ— äººæœºçš„ç¯å¢ƒæ•°æ®é‡‡é›†ä¸ä¸ŠæŠ¥æ¨¡å—</h2>
      
      <div class="flex flex-row flex-wrap max-md:gap-4 gap-10">
        <p>ğŸ“… 2024-08-28</p>
        
          <p>ğŸ”„ 2024-08-28</p>
        
        <p>âŒš Reading time: 6 min</p>
      </div>
      
      <div class="flex flex-row gap-2 flex-nowrap">
        <p class="py-1">ğŸ·ï¸</p>
<div class="flex flex-wrap gap-2">
  
    <a href='/tags/project'
    class="border border-sky-400 p-1 hover:bg-sky-400 focus:bg-sky-400 text-center">project</a>
  
    <a href='/tags/rt-thread'
    class="border border-sky-400 p-1 hover:bg-sky-400 focus:bg-sky-400 text-center">rt-thread</a>
  
    <a href='/tags/stm32'
    class="border border-sky-400 p-1 hover:bg-sky-400 focus:bg-sky-400 text-center">stm32</a>
  
    <a href='/tags/w5500'
    class="border border-sky-400 p-1 hover:bg-sky-400 focus:bg-sky-400 text-center">w5500</a>
  
    <a href='/tags/iot'
    class="border border-sky-400 p-1 hover:bg-sky-400 focus:bg-sky-400 text-center">IoT</a>
  
    <a href='/tags/sensor'
    class="border border-sky-400 p-1 hover:bg-sky-400 focus:bg-sky-400 text-center">sensor</a>
  
    <a href='/tags/socket'
    class="border border-sky-400 p-1 hover:bg-sky-400 focus:bg-sky-400 text-center">socket</a>
  
</div>
      </div>
      <hr />
      <div class="flex flex-col gap-10">
        <div class="prose prose-invert max-w-full">
          <h2 id="0-ä»‹ç»">0. ä»‹ç»</h2>
<img src="./images/data-collector-rt-3.png" width="300" style="display: block; margin: auto;">
<p>è¿™æ˜¯ä¸€ä¸ªç‰©è”ç½‘é¡¹ç›®ï¼Œåˆä½œå…¬å¸çš„ä¸»è¦ä¸šåŠ¡æ˜¯ä½¿ç”¨æ— äººæœºè¿›è¡Œå¯†é—­ç¯å¢ƒçš„æ— äººæ£€æµ‹ï¼Œå¦‚èˆ¹èˆ¶ã€å¤§å‹é”…ç‚‰ã€åŒ–å·¥å‚å‚¨ç½ç­‰å†…éƒ¨è§‚å¯Ÿæ£€æµ‹ã€‚è¯¥é¡¹ç›®éœ€è¦å¼€å‘ä¸€å¥—ç”¨äºå¯†é—­ç¯å¢ƒè¿‘è§‚æ£€æµ‹çš„æ— äººæœºç³»ç»Ÿï¼Œæ¶µç›–ç¡¬ä»¶è®¾è®¡ã€è½¯ä»¶å¼€å‘ä¸ç³»ç»Ÿé›†æˆã€‚è¯¥ç³»ç»Ÿç”±æ— äººæœºç«¯ã€åœ°é¢ç›‘æ§ç«¯å’Œæ•°æ®ä¼ è¾“ä¸ç³»ç•™ä¾›ç”µæ¨¡å—ç»„æˆï¼Œä¸“é—¨ç”¨äºå¯†é—­ç©ºé—´å†…çš„ç²¾ç»†æ£€æµ‹ä»»åŠ¡ã€‚æ— äººæœºç«¯æ­è½½é«˜æ¸…ç›¸æœºã€é£æ§ç³»ç»Ÿï¼Œä»¥åŠ<strong>ä¸€ä¸ªåŸºäº STM32F407 çš„ç¯å¢ƒæ•°æ®é‡‡é›†ä¸ä¸ŠæŠ¥æ¨¡å—</strong>ã€‚è¯¥æ¨¡å—é€šè¿‡å¤–æŒ‚çš„ W5500 èŠ¯ç‰‡ä¸æ— äººæœºå±€åŸŸç½‘å†…çš„æœºè½½å·¥æ§æœºè¿›è¡Œé€šä¿¡ï¼Œé‡‡ç”¨ UDP åè®®å®ç°æ•°æ®ä¼ è¾“ã€‚</p>
<p><strong>æˆ‘è´Ÿè´£ç¯å¢ƒæ•°æ®é‡‡é›†ä¸ä¸ŠæŠ¥æ¨¡å—çš„æ‰€æœ‰è½¯ä»¶åŠŸèƒ½å¼€å‘</strong>ã€‚</p>
<p><a href="https://github.com/xym-ee/data-collector-rt"><strong>æºç ä»“åº“</strong></a></p>
<h2 id="1-ç¡¬ä»¶æ–¹æ¡ˆ">1. ç¡¬ä»¶æ–¹æ¡ˆ</h2>
<img src="./images/data-collector-rt-1-2.png" width="200" style="display: block; margin: auto;">
<p>æ­¤é¡¹ç›®æˆ‘ä¸è´Ÿè´£ç¡¬ä»¶è®¾è®¡éƒ¨åˆ†ï¼Œä½†è¿™é‡Œä¹Ÿç®€å•ä»‹ç»ä¸€ä¸‹ç¡¬ä»¶æ–¹æ¡ˆã€‚</p>
<ul>
<li>ä¸»æ§èŠ¯ç‰‡ï¼šSTM32F407VET6</li>
<li>ç½‘ç»œèŠ¯ç‰‡ï¼šW5500</li>
</ul>
<p>W5500(<a href="https://atta.szlcsc.com/upload/public/pdf/source/20230714/E10C32B058E0BA54FCE1C1556BE10C07.pdf">datasheet</a>)æ˜¯ä¸€æ¬¾å…¨ç¡¬ä»¶ TCP/IP åè®®æ ˆä»¥å¤ªç½‘æ§åˆ¶å™¨ï¼Œå†…éƒ¨é›†æˆäº†ä»¥å¤ªç½‘æ•°æ®é“¾è·¯å±‚ï¼ˆMACï¼‰å’Œä»¥å¤ªç½‘ç‰©ç†å±‚ï¼ˆPHYï¼‰ï¼Œå†…åµŒçš„ 8 ä¸ªç‹¬ç«‹ç¡¬ä»¶ Socket å¯ä»¥è¿›è¡Œ 8 è·¯ç‹¬ç«‹é€šä¿¡ã€‚ä½¿ç”¨æ ‡å‡† 4 çº¿ SPI æ¥å£ä¸ä¸»æœºè¿›è¡Œé€šä¿¡ã€‚</p>
<p>ä¼ æ„Ÿå™¨éƒ¨åˆ†</p>
<ul>
<li>1 ä¸ªé«˜ç²¾åº¦æ¸©åº¦ä¼ æ„Ÿå™¨ MCP9808
<ul>
<li>IIC æ¥å£</li>
</ul>
</li>
<li>2 ä¸ªç”µåŒ–å­¦å¯ç‡ƒæ°”ä½“æµ“åº¦ä¼ æ„Ÿå™¨
<ul>
<li>UART æ¥å£</li>
</ul>
</li>
<li>3 ä¸ª ToF è·ç¦»ä¼ æ„Ÿå™¨
<ul>
<li>IIC æ¥å£</li>
</ul>
</li>
</ul>
<p>æ­¤å¤–ï¼Œè¿˜æœ‰å…± 20 ä¸ª GPIO ç”¨æ¥æ§åˆ¶ç¯å…‰ã€ç”µæºçš„å¼€å…³ã€‚</p>
<table>
<thead>
<tr>
<th>æ¿€å…‰æµ‹è·ä¼ æ„Ÿå™¨</th>
<th>å¯ç‡ƒæ°”ä½“æµ“åº¦ä¼ æ„Ÿå™¨</th>
<th>é«˜ç²¾åº¦æ¸©åº¦ä¼ æ„Ÿå™¨</th>
</tr>
</thead>
<tbody>
<tr>
<td><img src="./images/data-collector-rt-2-2.png" width="200" style="display: block; margin: auto;"></td>
<td><img src="./images/data-collector-rt-2-3.png" width="100" style="display: block; margin: auto;"></td>
<td><img src="./images/data-collector-rt-2-4.png" width="200" style="display: block; margin: auto;"></td>
</tr>
</tbody>
</table>
<h2 id="2-è½¯ä»¶å¼€å‘æƒ…å†µæ€»ä½“ä»‹ç»">2. è½¯ä»¶å¼€å‘æƒ…å†µæ€»ä½“ä»‹ç»</h2>
<h3 id="rtos-é€‰æ‹©-rt-thread">RTOS é€‰æ‹©: rt-thread</h3>
<p>åœ¨è½¯ä»¶å¼€å‘ä¸Šï¼Œè€ƒè™‘åˆ°æ­¤æ¨¡å—å¤–æ¥çš„è®¾å¤‡è¾ƒå¤šå¹¶ä¸”éœ€è¦ç½‘ç»œåè®®æ ˆï¼Œè£¸æœºå¼€å‘å¯èƒ½ä¼šæ¯”è¾ƒæ£˜æ‰‹ï¼Œå› æ­¤åŸºäº RTOS å®Œæˆå¼€å‘ã€‚</p>
<p>æ¯”è¾ƒå¸¸ç”¨çš„ RTOS æ˜¯ freeRTOS ï¼Œæˆ‘å­¦ä¹ çš„ç¬¬ä¸€ä¸ªæ˜¯ rt-threadï¼Œrtt é™¤äº†å®æ—¶å†…æ ¸ï¼Œå¯¹è®¾å¤‡é©±åŠ¨ä¹Ÿåšäº†æŠ½è±¡ï¼Œæœ‰æ›´æ˜“è°ƒç”¨çš„æ–¹æ³•å’Œè½¯ä»¶åŒ…ï¼Œå› æ­¤åŸºäº rt-thread å¼€å‘è¯¥æ¨¡å—çš„è½¯ä»¶ã€‚æˆ‘çœ‹è¿‡ä¸€äº› freeRTOS é¡¹ç›®çš„æºç ï¼Œå¤–è®¾é©±åŠ¨å¤§å¤šæ˜¯å’Œè£¸æœºæ“ä½œä¸€æ ·åŸºäº HAL åº“æ¥å®Œæˆã€‚rtt è®¾è®¡ä¸€å¥—ç»Ÿä¸€çš„ api ï¼Œå’Œ linux ç±»ä¼¼ä½¿ç”¨ open close read write æ¥æ“ä½œè®¾å¤‡ï¼Œæ­¤å¤–æˆ‘æ›´å–œæ¬¢ rtt æºç é£æ ¼ï¼Œå…¶å’Œ linux é£æ ¼ç±»ä¼¼ä½¿ç”¨å…¨å°å†™+_çš„æ–¹å¼ã€‚</p>
<h3 id="è½¯ä»¶å¼€å‘æµç¨‹">è½¯ä»¶å¼€å‘æµç¨‹</h3>
<p>rtt å¯ä»¥ä½¿ç”¨ Keilã€IARã€RT-Thread Studioã€makefile æ¥å¼€å‘ï¼Œæˆ‘ä½¿ç”¨ Keil æ¥å¼€å‘ã€‚æ•´ä¸ªè½¯ä»¶çš„å¼€å‘æµç¨‹</p>
<pre tabindex="0"><code>BSP å¼€å‘ ---&gt;  ä¼ æ„Ÿå™¨é©±åŠ¨å¼€å‘  -&gt; ä¼ æ„Ÿå™¨é©±åŠ¨æµ‹è¯•    ---&gt; ä¸šåŠ¡åŠŸèƒ½å¼€å‘ -&gt; ä¸šåŠ¡åŠŸèƒ½æµ‹è¯• -&gt; æ•´æœºæµ‹è¯• -&gt; ç”Ÿäº§ç¯å¢ƒæµ‹è¯•
          \--&gt; ç½‘ç»œé€šä¿¡åŠŸèƒ½å¼€å‘ -&gt; ç½‘ç»œé€šä¿¡åŠŸèƒ½æµ‹è¯• -/ 
</code></pre><p>rt-thread ç°åœ¨ä¹Ÿæ¯”è¾ƒæˆç†Ÿäº†ï¼Œå¯¹ arm cortex-m å†…æ ¸ã€STM32 ç³»åˆ—æ”¯æŒçš„éƒ½æŒºå¥½ï¼Œä¸éœ€è¦åš kernel çš„ç§»æ¤å’Œå¤–è®¾é©±åŠ¨çš„å¼€å‘äº†ã€‚ä½†æ˜¯è¿™ä¸ªæ¿æ˜¯è‡ªå·±è®¾è®¡çš„ï¼Œå› æ­¤è¿˜æ˜¯è¦åšä¸€ä¸‹æ¿çº§é€‚é…ï¼Œéœ€è¦é€‚é…çš„åœ°æ–¹ä¹Ÿä¸å¤šï¼Œå‚è€ƒ<a href="https://www.rt-thread.org/document/site/#/rt-thread-version/rt-thread-standard/tutorial/make-bsp/stm32-bsp/STM32%E7%B3%BB%E5%88%97BSP%E5%88%B6%E4%BD%9C%E6%95%99%E7%A8%8B">å®˜æ–¹è¯´æ˜æ–‡æ¡£å…³äº BSP å¼€å‘çš„éƒ¨åˆ†</a></p>
<ul>
<li>é“¾æ¥è„šæœ¬å’Œ <code>board.h</code> ä¸­ï¼ŒæŒ‡å®š RAM å’Œ ROM çš„å¤§å°</li>
<li>ä½¿ç”¨ CubeMX é…ç½®æ—¶é’Ÿå’Œå¼•è„šå¤ç”¨</li>
<li>æ·»åŠ è¦ä½¿ç”¨çš„å¤–è®¾çš„ Kconfig é€‰é¡¹</li>
<li>é€‚é…é¡¹ç›®æ„å»ºè„šæœ¬å’Œå·¥ç¨‹é…ç½®æ¨¡æ¿</li>
</ul>
<p>rtt çš„ BSP ç›¸æ¯”äº linux è¿˜æ˜¯è¦ç®€å•çš„å¤šï¼Œrtt åœ¨ä¸€äº›è®¾è®¡ä¸Šå€Ÿé‰´äº† linuxï¼Œæ¯”å¦‚è¯´ä½¿ç”¨ Kconfig æ¥é…ç½®å†…æ ¸ç¼–è¯‘é€‰é¡¹ï¼Œä½¿ç”¨ menuconfig å·¥å…·æ¥é…ç½®éœ€è¦ä½¿ç”¨çš„å¤–è®¾ï¼Œè¿™ä¹Ÿä½¿å¾—ç†Ÿæ‚‰ rtt åä¸Šæ‰‹ linux ä¹Ÿä¼šæ›´å®¹æ˜“ä¸€äº›ã€‚</p>
<p>BSP å‡†å¤‡å¥½ä»¥åï¼Œä¸‹è½½åˆ°ç›®æ ‡æ¿ï¼Œmsh å°±èƒ½çœ‹åˆ°è¾“å‡ºå†…å®¹äº†ï¼Œä¸€äº›äº¤äº’æŒ‡ä»¤ä¹Ÿå¯ä»¥ä½¿ç”¨äº†ã€‚åé¢çš„ç½‘ç»œé€šä¿¡åŠŸèƒ½å’Œä¼ æ„Ÿå™¨é©±åŠ¨å¼€å‘å¯ä»¥å¹¶è¡Œè¿›è¡Œã€‚</p>
<h3 id="ä¸šåŠ¡åŠŸèƒ½å®ç°æ–¹å¼">ä¸šåŠ¡åŠŸèƒ½å®ç°æ–¹å¼</h3>
<p>æ­¤é¡¹ç›®ä¸šåŠ¡åŠŸèƒ½å¹¶ä¸å¤æ‚ï¼Œè¯»å„ä¸ªä¼ æ„Ÿå™¨çš„æ•°æ®ç„¶åé€šè¿‡ç½‘ç»œå‘é€å°±å¯ä»¥äº†ã€‚é‡‡ç”¨äº†å¤šçº¿ç¨‹å®Œæˆï¼Œæ¯ä¸ªçº¿ç¨‹è´Ÿè´£ä¸åŒä¼ æ„Ÿå™¨çš„æ•°æ®é‡‡é›†æˆ–è®¾å¤‡æ§åˆ¶ã€‚æ‰€æœ‰æ•°æ®å’ŒæŒ‡ä»¤å­˜å‚¨åœ¨ä¸€ä¸ªå…¨å±€çš„æ•°æ®ç»“æ„ä½“ä¸­ï¼Œé€šè¿‡å„çº¿ç¨‹çš„è¯»å†™å®ç°äº†é«˜æ•ˆçš„æ•°æ®é€šä¿¡ã€‚UDP é€šä¿¡åˆ†ä¸ºå‘é€å’Œæ¥æ”¶ä¸¤ä¸ªçº¿ç¨‹ï¼Œä½¿ç”¨ä¸¤ä¸ªç«¯å£è¿›è¡Œæ•°æ®äº¤äº’ï¼Œç®€åŒ–äº†ç¨‹åºè®¾è®¡ï¼Œå¹¶ç¡®ä¿äº†å®æ—¶æ•°æ®çš„å¯é ä¼ è¾“ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/*-------------------- ç”µæºçŠ¶æ€ -------------------*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">enum</span> {
</span></span><span style="display:flex;"><span>    POWER_OFF <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    POWER_ON,
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">power_status_t</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">power_status_t</span> out_24v_en;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">power_status_t</span> pc_12v_en;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">power_status_t</span> cam_12v_en;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">power_status_t</span> ser_5v_en1;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">power_status_t</span> ser_5v_en2;    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">power_status_t</span> ser_5v_en3;    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">power_status_t</span> ser_5v_en4;    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">power_status_t</span> ser_5v_en5;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">power_status_t</span> iic_5v_en1;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">power_status_t</span> iic_5v_en2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_uint8_t</span> voltage_24v;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_uint8_t</span> voltage_led_18v;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_uint8_t</span> voltage_cam_12v;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_uint8_t</span> voltage_pc_12v;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_uint8_t</span> voltage_5v; 
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">power_t</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*-------------------- ç¯å…‰çŠ¶æ€ -------------------*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">enum</span> {
</span></span><span style="display:flex;"><span>    LIGHT_OFF <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    LIGHT_ON,
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">light_status_t</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">enum</span> {
</span></span><span style="display:flex;"><span>    LIGHT_17V <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    LIGHT_17_5V,
</span></span><span style="display:flex;"><span>    LIGHT_18V,
</span></span><span style="display:flex;"><span>    LIGHT_18_5V,
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">light_level_t</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">light_level_t</span>   level;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_uint8_t</span>      protect;    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">light_status_t</span>  light0;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">light_status_t</span>  light1;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">light_status_t</span>  light2;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">light_status_t</span>  light3;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">light_status_t</span>  light4;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">light_status_t</span>  light5;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">light_status_t</span>  light6;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">light_status_t</span> light7;
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">light_t</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*-------------------- ä¼ æ„Ÿå™¨çŠ¶æ€ -------------------*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_int16_t</span> temp;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_uint16_t</span> gas1;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_uint16_t</span> gas2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_uint16_t</span> distance1;      <span style="color:#75715e">/* å•ä½ cm */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_uint16_t</span> distance2;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_uint16_t</span> distance3;
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">seneor_t</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/*------------------------------------------------------------------*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">power_t</span> power;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">light_t</span> light;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">seneor_t</span> sensor;
</span></span><span style="display:flex;"><span>} <span style="color:#66d9ef">status_t</span>;
</span></span></code></pre></div><p><code>status_t status</code> ä¸ºå…¨å±€å˜é‡ï¼Œå­˜æ”¾æœ‰å…³è¯¥æ¨¡å—çš„æ‰€æœ‰æ•°æ®ã€‚</p>
<p>ä»»åŠ¡çº¿ç¨‹çš„è®¾è®¡ï¼š</p>
<ul>
<li>æ°”ä½“ä¼ æ„Ÿå™¨ 2 ä¸ªï¼Œæ¥åœ¨ 2 ä¸ª UART ä¸Šï¼Œæ¯ä¸ªä¼ æ„Ÿå™¨ 1 ä¸ªçº¿ç¨‹ï¼›</li>
<li>è·ç¦»ä¼ æ„Ÿå™¨ 3 ä¸ªï¼Œæ¥åœ¨ 1 ä¸ª IIC æ€»çº¿ä¸Šï¼Œåœ¨ 1 ä¸ªçº¿ç¨‹ä¸­è¯»å–æ•°æ®ï¼›</li>
<li>æ¸©åº¦ä¼ æ„Ÿå™¨ 1 ä¸ªï¼Œæ¥åœ¨ 1 ä¸ª IIC æ€»çº¿ä¸Šï¼Œåœ¨ 1 ä¸ªçº¿ç¨‹ä¸­è¯»å†™æ•°æ®ï¼›</li>
<li>ç¯å…‰æ§åˆ¶1ä¸ªçº¿ç¨‹</li>
<li>ç”µæºæ§åˆ¶1ä¸ªçº¿ç¨‹ã€‚</li>
</ul>
<p>udp æ¥æ”¶ä¸å‘é€å¤„äºç®€åŒ–ç¨‹åºè®¾è®¡çš„è€ƒè™‘ï¼Œä½¿ç”¨äº† 2 ä¸ªç«¯å£</p>
<ul>
<li>5500 ç«¯å£ï¼šæ¨¡å—ä½œä¸º UDP æœåŠ¡å™¨ï¼Œåªå‘ä¸Šä½æœºå‘é€ä¼ æ„Ÿå™¨æ•°æ®</li>
<li>5501 ç«¯å£ï¼šæ¨¡å—ä½œä¸º UDP å®¢æˆ·ç«¯ï¼Œåªæ¥æ”¶ä¸Šä½æœºçš„æ§åˆ¶æ•°æ®</li>
</ul>
<p>ä½¿ç”¨ä¸åŒçš„ç«¯å£æ¥åŒºåˆ†å‘é€å’Œæ¥æ”¶ä¸€äº›ä¼˜ç‚¹</p>
<ul>
<li>è°ƒè¯•æ–¹ä¾¿ï¼Œåˆ†å·¥æ¸…æ™°ï¼Œæ”¶å‘é€»è¾‘åˆ†å¼€è®¾è®¡</li>
<li>ä¸åœ¨ä¸€ä¸ªç«¯å£å‡å°æ•°æ®å†²çªçš„å¯èƒ½æ€§</li>
</ul>
<p>å¤§æ¦‚å·¥ä½œæµç¨‹ï¼Œé‡‡é›†ä¼ æ„Ÿå™¨æ•°æ®çš„çº¿ç¨‹ä¸æ–­è¯»å–æ•°æ®å†™å…¥ <code>status</code>ã€‚ç¯å…‰ç”µæºæ§åˆ¶çº¿ç¨‹ä¸æ–­ä»<code>status</code> è¯»æ•°æ®ï¼Œç„¶åæ ¹æ®æŒ‡ä»¤è¿›è¡Œæ§åˆ¶ã€‚udp å‘é€çº¿ç¨‹å¾ªç¯å‘é€<code> status</code> æ•°æ®ï¼Œudp æ¥æ”¶çº¿ç¨‹æ¥æ”¶ä¸Šä½æœºå‘é€çš„æ•°æ®ï¼Œç„¶åå†™å…¥ <code>status</code>ã€‚</p>
<h2 id="3ä¼ æ„Ÿå™¨é©±åŠ¨ä¸ç½‘ç»œåŠŸèƒ½å®ç°">3.ä¼ æ„Ÿå™¨é©±åŠ¨ä¸ç½‘ç»œåŠŸèƒ½å®ç°</h2>
<h3 id="uart-æ¥å£çš„ä¼ æ„Ÿå™¨é©±åŠ¨">UART æ¥å£çš„ä¼ æ„Ÿå™¨é©±åŠ¨</h3>
<p>ä¸¤ä¸ªå¯ç‡ƒæ°”ä½“æµ“åº¦ä¼ æ„Ÿå™¨ä¸º uart æ¥å£ï¼Œæ ¹æ®æ‰‹å†Œä½¿ç”¨ä¸²å£è°ƒè¯•åŠ©æ‰‹é…ç½®å‘é€é¢‘ç‡ 1hzï¼Œæ³¢ç‰¹ç‡ 9600ï¼Œä¸€ä¸ªæ•°æ®å¸§ä¸º 10 byteã€‚æ•°æ®æ ¼å¼</p>
<table>
<thead>
<tr>
<th style="text-align:center">byte[0]</th>
<th style="text-align:center">byte[1]</th>
<th style="text-align:center">byte[2]</th>
<th style="text-align:center">byte[3]</th>
<th style="text-align:center">byte[4]</th>
<th>byte[5]</th>
<th>byte[6]</th>
<th>byte[7]</th>
<th>byte[8]</th>
<th>byte[9]</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">FF</td>
<td style="text-align:center">01</td>
<td style="text-align:center">07</td>
<td style="text-align:center">02</td>
<td style="text-align:center">HH</td>
<td>LL</td>
<td>00</td>
<td>00</td>
<td>00</td>
<td>SUM</td>
</tr>
</tbody>
</table>
<p>byte[3] ä¸ºåˆ†è¾¨ç‡</p>
<ul>
<li>0x00  1</li>
<li>0x01  0.1</li>
<li>0x02  0.01</li>
<li>0x03  0.001</li>
</ul>
<p>å¦‚ä¸€æ¬¡æ•°æ®ä¸º <code>FF 01 07 02 00 55 00 00 00 5E</code>ï¼Œé‚£ä¹ˆæ°”ä½“æµ“åº¦ä¸º <code>((0x00&lt;&lt;8) | 0x55 )*0.01 = 0.85 ppm</code></p>
<p>ä¸²å£æ¶ˆæ¯æ¥æ”¶ä½¿ç”¨ DMA + ä¸²å£ç©ºé—²ä¸­æ–­çš„æ–¹å¼ã€‚ä½¿ç”¨ rtt çš„ uart é©±åŠ¨æ¡†æ¶æ¥å®ç°é€šä¿¡ã€‚</p>
<p>ä½¿ç”¨ rtt æä¾›çš„<strong>æ¶ˆæ¯é˜Ÿåˆ—æœºåˆ¶</strong>æ¥å®ç°ä¸²å£æ¥æ”¶ä¸­æ–­å›è°ƒå‡½æ•°å’Œæ¥æ”¶æ•°æ®å¤„ç†çº¿ç¨‹çš„åŒæ­¥ã€‚å½“ä¸€æ‰¹æ•°æ®æ¥æ”¶å®Œæˆï¼Œè¿›å…¥æ¥æ”¶ä¸­æ–­å›è°ƒå‡½æ•°ä¸­å‘é€ä¸€ä¸ªæ¶ˆæ¯ã€‚æ•°æ®å¤„ç†çº¿ç¨‹é˜»å¡ç­‰å¾…æ¥æ”¶æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ã€‚ç„¶åå¤„ç†æ•°æ®ï¼Œå¹¶å†™å…¥ <code>status</code> å…¨å±€å˜é‡ä¸­ã€‚</p>
<p>å®Œæ•´çš„æºç <a href="https://github.com/xym-ee/data-collector-rt/blob/main/applications/sensor/gas1.c">data-collector-rt/applications/sensor
/gas1.c</a>ï¼Œç®€åŒ–çš„ä»£ç </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">/* æ¥æ”¶æ•°æ®å›è°ƒå‡½æ•° */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">rt_err_t</span> <span style="color:#a6e22e">gas1_input</span>(<span style="color:#66d9ef">rt_device_t</span> dev, <span style="color:#66d9ef">rt_size_t</span> size)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* msg å®šä¹‰å’Œèµ‹å€¼ */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> <span style="color:#a6e22e">rt_mq_send</span>(<span style="color:#f92672">&amp;</span>rx_mq, <span style="color:#f92672">&amp;</span>msg, <span style="color:#66d9ef">sizeof</span>(msg));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* é”™è¯¯æ£€æŸ¥ */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* æ•°æ®å¤„ç†çº¿ç¨‹ */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">gas1_rx_thread</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>parameter)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> rx_msg msg;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_err_t</span> result;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_uint32_t</span> rx_length;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_uint8_t</span> rx_buffer[<span style="color:#ae81ff">12</span>];
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_uint8_t</span> <span style="color:#f92672">*</span>byte <span style="color:#f92672">=</span> rx_buffer;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_uint8_t</span> data_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rt_memset</span>(<span style="color:#f92672">&amp;</span>msg, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(msg));
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­è¯»å–æ¶ˆæ¯*/</span>
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> <span style="color:#a6e22e">rt_mq_recv</span>(<span style="color:#f92672">&amp;</span>rx_mq, <span style="color:#f92672">&amp;</span>msg, <span style="color:#66d9ef">sizeof</span>(msg), RT_WAITING_FOREVER);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (result <span style="color:#f92672">==</span> RT_EOK)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/* ä»ä¸²å£è¯»å–æ•°æ®*/</span>
</span></span><span style="display:flex;"><span>            rx_length <span style="color:#f92672">=</span> <span style="color:#a6e22e">rt_device_read</span>(msg.dev, <span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>rx_buffer[data_count], msg.size);
</span></span><span style="display:flex;"><span>            data_count <span style="color:#f92672">=</span> data_count <span style="color:#f92672">+</span> rx_length;
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (byte[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0xFF</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (data_count <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">10</span>) 
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    status.sensor.gas1 <span style="color:#f92672">=</span>  (byte[<span style="color:#ae81ff">4</span>]<span style="color:#f92672">&lt;&lt;</span><span style="color:#ae81ff">8</span> <span style="color:#f92672">|</span> byte[<span style="color:#ae81ff">5</span>]);
</span></span><span style="display:flex;"><span>                    data_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                data_count <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="iic-ä¼ æ„Ÿå™¨çš„é©±åŠ¨å¼€å‘">IIC ä¼ æ„Ÿå™¨çš„é©±åŠ¨å¼€å‘</h3>
<p>æ­¤é¡¹ç›®æœ‰ä¸¤ç±»ä¼ æ„Ÿå™¨ï¼Œ1 ä¸ªæ¸©åº¦ä¼ æ„Ÿå™¨ ï¼Œ3 ä¸ªè·ç¦»ä¼ æ„Ÿå™¨ã€‚è¿™ä¸¤ä¸ªä¼ æ„Ÿå™¨ä½¿ç”¨ç±»ä¼¼ï¼Œéƒ½å…ˆå‘é€ä¸€ä¸ªè¦è¯»çš„å¯„å­˜å™¨åœ°å€ï¼Œç„¶åè¯»å€¼å°±è¡Œã€‚è¿™é‡Œä»¥æ¸©åº¦ä¼ æ„Ÿå™¨ä¸ºä¾‹ã€‚å‹å·ä¸º MCP9808 (<a href="https://atta.szlcsc.com/upload/public/pdf/source/20180326/C129490_430B95D87F5D4C35CB02E453C03C190F.pdf">datasheet</a>)ã€‚</p>
<p>ç¨‹åºä¸Šä¹Ÿä¸å¤æ‚ï¼Œè½®è¯¢æŸ¥è¯¢çš„æ¨¡å¼ï¼Œä½¿ç”¨ rtt çš„ I2C æ¥å£æ¥å®Œæˆé€šä¿¡ã€‚å®Œæ•´çš„æºç <a href="https://github.com/xym-ee/data-collector-rt/blob/main/applications/sensor/iic_dev.c">data-collector-rt/applications/sensor/iic_dev.c</a>ï¼Œç®€åŒ–çš„ä»£ç </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">temperature1_thread</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>parameter)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_uint8_t</span> recv_buf[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_uint8_t</span> send_buf[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> {MCP9808_MODE_TA};
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">float</span> temperature <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rt_memset</span>(recv_buf, <span style="color:#ae81ff">0x00</span>, <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* å‘é€è¦è¯»çš„å¯„å­˜å™¨çš„åœ°å€ */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rt_i2c_master_send</span>(i2c_bus, MCP9808_ADDR, RT_I2C_WR, send_buf, <span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* è¯»å¯„å­˜å™¨ */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rt_i2c_master_recv</span>(i2c_bus, MCP9808_ADDR, RT_I2C_RD, recv_buf, <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* é«˜å­—èŠ‚é«˜ä½3bitä¸ºæ ‡å¿—ä½ */</span>
</span></span><span style="display:flex;"><span>        recv_buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> recv_buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x1F</span>;       <span style="color:#75715e">//Clear flag bits
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* é«˜å­—èŠ‚ bit4 ä¸ºç¬¦å·ä½ */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ((recv_buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x10</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x10</span>)         <span style="color:#75715e">//TA &lt; 0Â°C
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        { 
</span></span><span style="display:flex;"><span>            recv_buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> recv_buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x0F</span>;   <span style="color:#75715e">//Clear SIGN
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            temperature <span style="color:#f92672">=</span> <span style="color:#ae81ff">256.0</span> <span style="color:#f92672">-</span> (recv_buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">16.0</span> <span style="color:#f92672">+</span> recv_buf[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">/</span> <span style="color:#ae81ff">16.0</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>    <span style="color:#75715e">//TA Â³ 0Â°C
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        {
</span></span><span style="display:flex;"><span>            temperature <span style="color:#f92672">=</span> (recv_buf[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">*</span> <span style="color:#ae81ff">16.0</span> <span style="color:#f92672">+</span> recv_buf[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">/</span> <span style="color:#ae81ff">16.0</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        status.sensor.temp <span style="color:#f92672">=</span> temperature<span style="color:#f92672">*</span><span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rt_thread_mdelay</span>(<span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>å‚è€ƒæ‰‹å†Œçš„ 24 é¡µï¼Œè¯»ç¯å¢ƒæ¸©åº¦å¯„å­˜å™¨ï¼Œåœ°å€ä¸º 0x05ï¼ŒæŒ‰ç…§ 26 é¡µçš„è¯»å†™æ—¶åºå›¾å®Œæˆé€šä¿¡ã€‚</p>
<h3 id="ç½‘ç»œé€šä¿¡ç›¸å…³åŠŸèƒ½çš„å¼€å‘">ç½‘ç»œé€šä¿¡ç›¸å…³åŠŸèƒ½çš„å¼€å‘</h3>
<p>rtt æœ¬äº‹æ˜¯æœ‰ç½‘ç»œç»„ä»¶çš„ï¼Œæä¾›äº† SAL å¥—æ¥å­—æŠ½è±¡å±‚æä¾›äº† socket ç¼–ç¨‹æ¥å£ï¼Œè¿™ä½¿å¾—åœ¨ MCU ä¸Šè¿›è¡Œç½‘ç»œåº”ç”¨å¼€å‘å’Œåœ¨ linux ä¸Šçš„æ²¡æœ‰åŒºåˆ«ã€‚æ›´å¤šå…³äº rtt çš„ç½‘ç»œç»„å»ºçš„ä»‹ç»å‚è€ƒ <a href="https://www.rt-thread.org/document/site/#/rt-thread-version/rt-thread-standard/programming-manual/net/net_introduce">rt-thread æ–‡æ¡£ä¸­å¿ƒ-ç½‘ç»œç»„ä»¶</a>ã€‚</p>
<p>é™¤äº†ç¼–ç¨‹æ¥å£ï¼Œrtt ä¹Ÿæœ‰ä¸€ä¸ª netdev ç½‘å¡å±‚ã€‚</p>
<img src="https://www.rt-thread.org/document/site/rt-thread-version/rt-thread-standard/programming-manual/net/docs/network_frame.jpg" width="350" style="display: block; margin: auto;">
<p>æˆ‘ä½¿ç”¨äº† rtt çš„ <a href="https://github.com/RT-Thread-packages/wiznet">wiznet è½¯ä»¶åŒ…</a>ï¼ŒåŸºäº WIZnet å®˜ç½‘ ioLibrary_Driver ä»£ç åº“çš„ç§»æ¤å®ç°ï¼Œå¯¹æ¥ RT-Thread SAL å¥—æ¥å­—æŠ½è±¡å±‚ã€‚ä¸éœ€è¦åšå¤ªå¤šçš„åè®®æ ˆä¸Šçš„ç§»æ¤ï¼Œä½¿ç”¨èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿</p>
<p>w5500 ä½¿ç”¨ SPI æ€»çº¿é€šä¿¡ï¼Œå› æ­¤éœ€è¦åœ¨ç¡¬ä»¶ä¸Šåšä¸€äº›é…ç½®ï¼Œæ­¤é¡¹ç›®ä½¿ç”¨äº† spi2ï¼Œw5500è®¾å¤‡æ³¨å†Œåˆ° spi2 æ€»çº¿ä¸Šï¼Œå¹¶æŒ‡å®šå¤ä½å¼•è„šã€‚å”¯ä¸€è¦åšçš„å°±æ˜¯æŒ‡å®šé€šä¿¡ç”¨çš„æ€»çº¿è®¾å¤‡çš„åå­—ï¼Œè®¾å¤‡æ³¨å†Œå‡½æ•°</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">extern</span> <span style="color:#66d9ef">rt_err_t</span> <span style="color:#a6e22e">rt_hw_spi_device_attach</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>bus_name, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>device_name, GPIO_TypeDef <span style="color:#f92672">*</span>cs_gpiox, <span style="color:#66d9ef">uint16_t</span> cs_gpio_pin);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">rt_hw_spi_device_attach</span>(<span style="color:#e6db74">&#34;spi2&#34;</span>, <span style="color:#e6db74">&#34;spi20&#34;</span>, GPIOB, GPIO_PIN_12);
</span></span></code></pre></div><p>netdev ç½‘å¡å±‚æä¾›äº†å¸¸ç”¨çš„ç½‘ç»œå‘½ä»¤å¦‚ ping ifconfig netstat ç­‰ã€‚è¿™éƒ¨åˆ†é…ç½®å¥½ä»¥åï¼Œæ’ä¸Šç½‘çº¿ï¼Œå°±å·²ç»å¯ä»¥ ping é€šä¸€ä¸ªç½‘æ®µçš„ä¸»æœºäº†ã€‚ç„¶åå°±å¯ä»¥ç›´æ¥ä½¿ç”¨ socket çš„ api æ¥è¿›è¡Œåº”ç”¨å¼€å‘ã€‚</p>
<ul>
<li><a href="https://github.com/xym-ee/data-collector-rt/blob/main/applications/udpserver.c">udp server æºç </a></li>
<li><a href="https://github.com/xym-ee/data-collector-rt/blob/main/applications/udpclient.c">udp client æºç </a></li>
</ul>
<p>udp server çš„æ ¸å¿ƒä»£ç </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">udpserver_thread_entry</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>parameter)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> sock;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> bytes_read;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>recv_data;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">socklen_t</span> addr_len;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sockaddr_in server_addr, client_addr;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* åˆ†é…æ¥æ”¶ç”¨çš„æ•°æ®ç¼“å†² */</span>
</span></span><span style="display:flex;"><span>    recv_data <span style="color:#f92672">=</span> <span style="color:#a6e22e">rt_malloc</span>(BUFSZ); <span style="color:#75715e">/* é”™è¯¯æ£€æŸ¥ */</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* åˆ›å»ºä¸€ä¸ªsocketï¼Œç±»å‹æ˜¯SOCK_DGRAMï¼ŒUDPç±»å‹ */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((sock <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET, SOCK_DGRAM, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* é”™è¯¯æ£€æŸ¥ã€èµ„æºé‡Šæ”¾ã€é”™è¯¯æ—¥å¿—è¾“å‡ºã€ç¨‹åºé€€å‡º */</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* åˆå§‹åŒ–æœåŠ¡ç«¯åœ°å€ */</span>
</span></span><span style="display:flex;"><span>    server_addr.sin_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>    server_addr.sin_port <span style="color:#f92672">=</span> <span style="color:#a6e22e">htons</span>(UDP_RECIVE_PORT);
</span></span><span style="display:flex;"><span>    server_addr.sin_addr.s_addr <span style="color:#f92672">=</span> INADDR_ANY;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rt_memset</span>(<span style="color:#f92672">&amp;</span>(server_addr.sin_zero), <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(server_addr.sin_zero));
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* ç»‘å®šsocketåˆ°æœåŠ¡ç«¯åœ°å€ */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">bind</span>(sock, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>server_addr, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> sockaddr)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* é”™è¯¯æ£€æŸ¥ã€èµ„æºé‡Šæ”¾ã€é”™è¯¯æ—¥å¿—è¾“å‡ºã€ç¨‹åºé€€å‡º */</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    addr_len <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> sockaddr);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rt_kprintf</span>(<span style="color:#e6db74">&#34;UDPServer Waiting for client on port 5500...</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_uint8_t</span> msg_length <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* æ¥è‡ªä¸Šä½æœºçš„æ•°æ®çš„è¯»å– */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* ä»sockä¸­æ”¶å–æœ€å¤§BUFSZ - 1å­—èŠ‚æ•°æ® */</span>
</span></span><span style="display:flex;"><span>        bytes_read <span style="color:#f92672">=</span> <span style="color:#a6e22e">recvfrom</span>(sock, recv_data, BUFSZ <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>client_addr, <span style="color:#f92672">&amp;</span>addr_len);
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/*------------------------------- å¸§å¤´åˆ¤æ–­ ------------------------------------*/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( (recv_data[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0x55</span>) <span style="color:#f92672">&amp;&amp;</span> (recv_data[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">==</span><span style="color:#ae81ff">0x55</span>) )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            msg_length <span style="color:#f92672">=</span> recv_data[<span style="color:#ae81ff">3</span>];  <span style="color:#75715e">/* byte3ä¸ºæ•°æ®é•¿åº¦ */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/*------------------------------- æ±‚å’Œæ ¡éªŒ ------------------------------------*/</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">rt_uint8_t</span> sum <span style="color:#f92672">=</span> <span style="color:#a6e22e">sum_check</span>((<span style="color:#66d9ef">rt_uint8_t</span><span style="color:#f92672">*</span>)recv_data, <span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> msg_length);
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (recv_data[<span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> msg_length] <span style="color:#f92672">==</span> sum)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">switch</span>(recv_data[<span style="color:#ae81ff">2</span>])
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">/* ä¼ å…¥ç¬¬ä¸€ä¸ªæ•°æ®çš„èµ·å§‹åœ°å€ */</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">case</span> RMSG_ID_POWER : <span style="color:#a6e22e">rmsg_power_handle</span>((<span style="color:#66d9ef">rt_uint8_t</span><span style="color:#f92672">*</span>)(<span style="color:#f92672">&amp;</span>recv_data[<span style="color:#ae81ff">4</span>])); <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">case</span> RMSG_ID_LIGHT : <span style="color:#a6e22e">rmsg_lighr_handle</span>((<span style="color:#66d9ef">rt_uint8_t</span><span style="color:#f92672">*</span>)(<span style="color:#f92672">&amp;</span>recv_data[<span style="color:#ae81ff">4</span>])); <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">default</span> <span style="color:#f92672">:</span> ; <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">rt_kprintf</span>(<span style="color:#e6db74">&#34;sum error~</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);            
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">rt_kprintf</span>(<span style="color:#e6db74">&#34;head error~</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">closesocket</span>(sock);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rt_free</span>(recv_data);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>udp client çš„æ ¸å¿ƒä»£ç </p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">udpclient_thread_entry</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>parameter)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rt_uint8_t</span> send_data[<span style="color:#ae81ff">20</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0x55</span>, <span style="color:#ae81ff">0x55</span>};
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> sock;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> hostent <span style="color:#f92672">*</span>host;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">struct</span> sockaddr_in server_addr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    host <span style="color:#f92672">=</span> (<span style="color:#66d9ef">struct</span> hostent <span style="color:#f92672">*</span>) <span style="color:#a6e22e">gethostbyname</span>(UDP_SERVER_IP);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* åˆ›å»ºä¸€ä¸ªsocketï¼Œç±»å‹æ˜¯SOCK_DGRAMï¼ŒUDPç±»å‹ */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((sock <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_INET, SOCK_DGRAM, <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* é”™è¯¯æ£€æŸ¥ã€èµ„æºé‡Šæ”¾ã€é”™è¯¯æ—¥å¿—è¾“å‡ºã€ç¨‹åºé€€å‡º */</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* åˆå§‹åŒ–é¢„è¿æ¥çš„æœåŠ¡ç«¯åœ°å€ */</span>
</span></span><span style="display:flex;"><span>    server_addr.sin_family <span style="color:#f92672">=</span> AF_INET;
</span></span><span style="display:flex;"><span>    server_addr.sin_port <span style="color:#f92672">=</span> <span style="color:#a6e22e">htons</span>(UDP_SERVER_PORT);
</span></span><span style="display:flex;"><span>    server_addr.sin_addr <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>((<span style="color:#66d9ef">struct</span> in_addr <span style="color:#f92672">*</span>)host<span style="color:#f92672">-&gt;</span>h_addr);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">rt_memset</span>(<span style="color:#f92672">&amp;</span>(server_addr.sin_zero), <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(server_addr.sin_zero));
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* å‘é€æ•°æ® */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/*----------------------------------  ç”µå‹ä¿¡æ¯ä¸ŠæŠ¥ --------------------------------*/</span>
</span></span><span style="display:flex;"><span>        send_data[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> SMSG_ID_VOLTAGE;     <span style="color:#75715e">/* å‘é€æ¶ˆæ¯ID   */</span>
</span></span><span style="display:flex;"><span>        send_data[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>;                   <span style="color:#75715e">/* å‘é€æ•°æ®é•¿åº¦ */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* ,,,, å…¶ä»–æ•°æ® */</span>
</span></span><span style="display:flex;"><span>        send_data[<span style="color:#ae81ff">12</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">sum_check</span>(send_data, <span style="color:#ae81ff">12</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sendto</span>(sock, send_data, <span style="color:#ae81ff">13</span>, <span style="color:#ae81ff">0</span>, (<span style="color:#66d9ef">struct</span> sockaddr <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>server_addr, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">struct</span> sockaddr));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/*----------------------------------  ç”µæºä¸ç¯å…‰å¼€å¯çŠ¶æ€ä¸ŠæŠ¥ --------------------------------*/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//******* å…¶ä»–æ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯ç±»ä¼¼çš„å‘é€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">rt_thread_mdelay</span>(<span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/* å…³é—­è¿™ä¸ªsocket */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//closesocket(sock);    
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p>udp server æ¥æ”¶ä¸Šä½æœºå‘é€çš„æ§åˆ¶æŒ‡ä»¤ï¼Œudp client å‘ä¸Šä½æœºå‘é€æ‰€æœ‰çš„æ•°æ®ã€‚</p>
<p>å‡ºäºç¼–ç¨‹çš„æ–¹ä¾¿å’Œ MCU æ€§èƒ½çš„è€ƒè™‘ï¼Œè¿™é‡Œå‘é€å’Œæ¥æ”¶çš„éƒ½æ˜¯ç”¨çš„åŸå§‹çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œåè®®æ ¼å¼ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæˆ‘è®¾è®¡å¥½äº†ä»¥åæŠŠåè®®æ–‡æ¡£äº¤ç»™ä¸Šä½æœºçš„å·¥ç¨‹å¸ˆï¼Œç„¶åä½¿ç”¨ç½‘ç»œè°ƒè¯•åŠ©æ‰‹å°±èƒ½è°ƒè¯•äº†ã€‚</p>
<h2 id="4å¯ä»¥æ”¹è¿›çš„åœ°æ–¹">4.å¯ä»¥æ”¹è¿›çš„åœ°æ–¹</h2>
<h3 id="è½¯ä»¶åˆ†å±‚ä¼ æ„Ÿå™¨é©±åŠ¨æ¡†æ¶">è½¯ä»¶åˆ†å±‚ã€ä¼ æ„Ÿå™¨é©±åŠ¨æ¡†æ¶</h3>
<p>å…³äºè½¯ä»¶çš„åˆ†å±‚è®¾è®¡ã€‚å‰é¢å†™ç€ä¼ æ„Ÿå™¨é©±åŠ¨ï¼Œä½†å®é™…ä¸Šä¼ æ„Ÿå™¨é©±åŠ¨å’Œåº”ç”¨è¿˜æ˜¯æ··æ‚åœ¨äº†ä¸€ä¸ªçº¿ç¨‹é‡Œäº†ï¼Œæˆ‘åªæ˜¯ä½¿ç”¨äº† rtt çš„ç‰‡å†…å¤–è®¾é©±åŠ¨æ¥å£ï¼Œå¹¶æ²¡æœ‰ç»™ä¼ æ„Ÿå™¨æŠ½è±¡å‡º read æ¥å£ã€‚å½“ç„¶è¿™å‡ ä¸ªä¼ æ„Ÿå™¨é€šä¿¡éƒ½æ¯”è¾ƒç®€å•ã€‚</p>
<p>æŒ‰ç…§ linux é©±åŠ¨çš„æ¦‚å¿µï¼Œå¤–è®¾é©±åŠ¨å³æ€»çº¿é©±åŠ¨ï¼Œä¼ æ„Ÿå™¨é©±åŠ¨å³è®¾å¤‡é©±åŠ¨ï¼Œrtt è®¾è®¡äº† sensor è®¾å¤‡æ¡†æ¶ï¼ŒæŠ½è±¡å‡ºäº†ä¸€äº›é€šç”¨çš„ api å¦‚</p>
<ul>
<li><code>rt_device_find()</code> æ ¹æ®åå­—è·å¾—ä¼ æ„Ÿå™¨è®¾å¤‡å¥æŸ„</li>
<li><code>rt_device_read()</code> è¯»ä¼ æ„Ÿå™¨å€¼</li>
<li><code>rt_device_control()</code> ä¼ æ„Ÿå™¨æ§åˆ¶ï¼Œå¦‚ç²¾åº¦</li>
</ul>
<p>å¯ä»¥å°†ä¼ æ„Ÿå™¨å¯¹æ¥åˆ°æ­¤æ¡†æ¶ä¸­ï¼Œå®ç°çœŸæ­£çš„é©±åŠ¨å’Œåº”ç”¨åˆ†ç¦»ï¼Œå°†æ¥æ›´æ¢ä¼ æ„Ÿå™¨ä¹Ÿæ— éœ€ä¿®æ”¹åº”ç”¨ä»£ç ã€‚æˆ‘å®ç°çš„æ¸©åº¦ä¼ æ„Ÿå™¨MCP9808çš„é©±åŠ¨ <a href="https://github.com/xym-ee/rtt_sensor_mcp9808">rtt_sensor_mcp9808</a>ã€‚</p>
<h3 id="å…±äº«å†…å­˜è¯»å†™çš„ä¿æŠ¤">å…±äº«å†…å­˜è¯»å†™çš„ä¿æŠ¤</h3>
<p>è¿™é‡Œä½¿ç”¨å…±äº«å†…å­˜åœ¨å¤šçº¿ç¨‹ä¹‹é—´ä¼ é€’æ•°æ®ã€‚äºæƒ…äºç†æ¥è®²ï¼Œéƒ½è¦ç”¨äº’æ–¥é”ä¿æŠ¤è¿™å—æ•°æ®ï¼Œæ”¾ç½®å‡ºç°åå€¼ã€‚</p>
<p>ä½†æ˜¯æ²¡æœ‰ä½¿ç”¨äº’æ–¥é”å¥½åƒä¹Ÿæ²¡å‡ºç°é—®é¢˜ï¼Œåˆ†æåŸå› ã€‚</p>
<h3 id="ä»£ç ç»“æ„ä¸Š">ä»£ç ç»“æ„ä¸Š</h3>
<p>ä»£ç ç»“æ„çš„ä¼˜åŒ–ï¼Œæ°”ä½“æµ“åº¦ä¼ æ„Ÿå™¨ä½¿ç”¨äº†ä¸¤ä¸ªä¸²å£ï¼Œç›®å‰çš„åšæ³•æ˜¯æ¯ä¸ªä¼ æ„Ÿå™¨ä¸€ä¸ªçº¿ç¨‹ï¼Œä»£ç ç›´æ¥å¤åˆ¶äº†ä¸¤ä»½ï¼Œæ”¾åœ¨äº†ä¸¤ä¸ª .c é‡Œï¼Œè¿™ä¸¤ä»½ä»£ç é€»è¾‘å®Œå…¨ç›¸åŒï¼Œç”šè‡³å†…å®¹ä¹Ÿå‡ ä¹ç›¸åŒã€‚</p>
<p>å¯ä»¥è€ƒè™‘ç»™çº¿ç¨‹å…¥å£ä¼ å…¥å‚æ•°æ¥åŒºåˆ«ï¼Œä½¿ç”¨ä¸€ä»½ä»£ç å®Œæˆä¸¤ä¸ªä¸²å£çš„è¯»å’Œå†™ã€‚</p>
<h2 id="5å¼€å‘ä¸­-bug-æ€»ç»“">5.å¼€å‘ä¸­ bug æ€»ç»“</h2>
<p>è™½ç„¶æ„Ÿè§‰å†™èµ·æ¥å¥½åƒæŒºè½»æ¾ğŸ˜‚ï¼Œä½†æ˜¯å®é™…è°ƒè¯•çš„æ—¶å€™è¿˜æ˜¯é‡åˆ°äº†ä¸å°‘é—®é¢˜ï¼Œå°¤å…¶æ˜¯ç½‘ç»œåŒ…çš„é€‚é…ã€‚</p>
<p>ä¸€ä¸ªæœ‰æ„æ€çš„äº‹æƒ…ï¼Œè°ƒè¯•çš„æ—¶å€™æ¨¡å—æ’åœ¨è·¯ç”±å™¨èƒ½å’Œä¸»æœºé€šä¿¡ï¼Œä½†æ˜¯ç°åœºä½¿ç”¨çš„æ˜¯äº¤æ¢æœºï¼Œæ€»æ˜¯ä¼šæç¤ºå·²ç»å­˜åœ¨ä¸€ä¸ªæ²¡å…³é—­çš„è¿æ¥ï¼Œã€‚ç„¶ååé¢æµ‹è¯•å‘ç°é€šç”µçš„æ—¶å€™è¿è·¯ç”±å™¨ï¼Œç„¶åæ¢åˆ°äº¤æ¢æœºä¸Šï¼Œä¹Ÿæ˜¯å¯ä»¥æ­£å¸¸é€šä¿¡çš„ã€‚</p>
<p>ç„¶åå•æ­¥è°ƒè¯•ï¼Œå‘ç°ç½‘å¡åˆå§‹åŒ–çš„æ—¶å€™å›è¿æ¥ rt-thread çš„å®˜ç½‘æµ‹è¯•ç½‘ç»œæ˜¯å¦å·¥ä½œæ­£å¸¸ï¼Œæ¨¡å—è¿è·¯ç”±å™¨èƒ½è®¿é—®å‘¢å¤–ç½‘ï¼Œè¿äº¤æ¢æœºæ²¡æ³•è®¿é—®ï¼Œç„¶åå°±ä¸€ç›´å°è¯•è¿æ¥ï¼ŒğŸ˜‚ã€‚è¿™ä¸ªé—®é¢˜æŠ˜è…¾äº†å¥½å‡ å¤©ï¼Œåæ¥æ‰å‘ç° menuconfig ä¸­å¯ä»¥é…ç½®æ˜¯å¦é€šè¿‡å¤–ç½‘æµ‹è¯•ç½‘ç»œè¿æ¥æ­£å¸¸ï¼Œå»æ‰è¿™ä¸ªé€‰é¡¹å°±å¥½äº†ã€‚</p>
<h2 id="6éœ€è¦æ·±å…¥å­¦ä¹ çš„åœ°æ–¹">6.éœ€è¦æ·±å…¥å­¦ä¹ çš„åœ°æ–¹</h2>
<p>å…³äºç½‘ç»œéƒ¨åˆ†ï¼Œåº•å±‚ç”¨çš„æ˜¯ lwip åè®®æ ˆã€‚ä»¥åŠç½‘å¡å¦‚ä½•ä¸€å±‚å±‚æŠ½è±¡ï¼Œå¯¹æ¥çš„ socket æ¥å£ï¼Œæˆ‘è§‰å¾—éƒ½æœ‰å­¦ä¹ ä»·å€¼ã€‚</p>

          <hr />
        </div>
        <div>
          

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
    this.page.url = "https:\/\/xym.work\/blog\/data-collector-rt.html";
    this.page.identifier = ""; 
    };
    (function () { 
      var d = document, s = d.createElement('script');
      s.src = 'https://xym.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>


        </div>
      </div>
    </div>

    <div class="footer flex items-center justify-center">
  <div class="py-4">
  <footer>
    <p class="whitespace-nowrap">Â© 2024. <a href="https://github.com/xym-ee" target="_blank">xym-ee
    </a> all rights reserved.</p>
  </footer>
</div>
</div>
  </div>
  

  </div>
  
        <script type="text/javascript" src="/js/navbar.min.a2e7a3db4f1b58e7616cfd31a099340a207d5b99d96df87f525f17c604e184c1.js" integrity="sha256-ouej208bWOdhbP0xoJk0CiB9W5nZbfh/Ul8XxgThhME=" crossorigin="anonymous"></script>

  <script id="dsq-count-scr" src="//nayanseth.disqus.com/count.js" async></script>
  <script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$']],  
      displayMath: [['$$', '$$']]  
    }
  };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script><script>
    document.addEventListener('DOMContentLoaded', function() {
      const icon1 = document.getElementById('svgwechat');
      const tooltip1 = document.getElementById('wechattip');

      icon1.addEventListener('mouseenter', function(event) {
        const rect = icon1.getBoundingClientRect();

        
        tooltip1.style.left = `${rect.left + window.scrollX - 100}px`;
        tooltip1.style.top = `${rect.bottom + window.scrollY + 20}px`;

        tooltip1.style.display = 'block';
      });

      icon1.addEventListener('mouseleave', function() {
        tooltip1.style.display = 'none';
      });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
      const icon2 = document.getElementById('svgqq');
      const tooltip2 = document.getElementById('qqtip');

      icon2.addEventListener('mouseenter', function(event) {
        const rect = icon2.getBoundingClientRect();

        
        tooltip2.style.left = `${rect.left + window.scrollX -100 }px`;
        tooltip2.style.top = `${rect.bottom + window.scrollY + 20}px`;

        tooltip2.style.display = 'block';
      });

      icon2.addEventListener('mouseleave', function() {
        tooltip2.style.display = 'none';
      });
    });
</script>

</body>

</html>